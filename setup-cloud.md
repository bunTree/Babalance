# 云开发设置指南

## 🚀 快速设置步骤

### 1. 部署云函数

**在微信开发者工具中：**

1. **右键点击** `cloudfunctions/login` 文件夹
2. **选择** "上传并部署：云端安装依赖"
3. **等待部署完成** (看到绿色的"✓"标志)

**或使用命令行：**
```bash
# 进入项目根目录
cd /path/to/Babalance

# 安装微信开发者工具命令行工具
# 然后执行部署命令（需要先在开发者工具中登录）
```

### 2. 创建数据库集合

1. **打开云开发控制台**
   - 在微信开发者工具中点击"云开发"
   - 或访问 https://console.cloud.tencent.com/tcb

2. **进入数据库管理**
   - 点击左侧"数据库"
   - 点击"集合管理"

3. **创建集合**
   - 点击"添加集合"
   - 集合名称：`b-user`
   - 点击"确定"

### 3. 设置数据库权限

**重要：这是解决写入问题的关键步骤！**

1. **选择集合** `b-user`
2. **点击"权限设置"**
3. **选择权限模式**：
   - 推荐：**"仅创建者可读写"**
   - 或者：**"所有用户可读，仅创建者可写"**
4. **保存设置**

### 4. 环境配置检查

确保 `app.js` 中的环境ID正确：
```javascript
wx.cloud.init({
  env: 'cloud1-3gkpl0rm53f6eed4',  // 您的环境ID
  traceUser: true,
})
```

## 🔍 常见问题解决

### 问题1：云函数调用失败
**解决方案：**
- 确保云函数已正确部署
- 检查函数名称是否正确
- 查看云函数日志

### 问题2：数据库连接失败  
**解决方案：**
- 确认集合 `b-user` 已创建
- 检查环境ID是否正确
- 确保网络连接正常

### 问题3：写入权限不足
**解决方案：**
- 将数据库权限设置为"仅创建者可读写"
- 确保用户已正确登录（有openid）

### 问题4：openid获取失败
**解决方案：**
- 检查网络连接
- 重启微信开发者工具
- 确保云函数已部署

## 🧪 测试方法

1. **使用长按诊断**：在小程序中长按头像进行诊断
2. **控制台测试**：复制 `cloud-check.js` 内容到控制台执行
3. **查看日志**：在云开发控制台查看云函数日志

## 📋 权限配置详解

### 仅创建者可读写（推荐）
```json
{
  "read": "auth.openid == doc._openid",
  "write": "auth.openid == doc._openid"
}
```

### 所有用户可读，仅创建者可写
```json
{
  "read": true,
  "write": "auth.openid == doc._openid"
}
```

## 🔔 注意事项

1. **确保小程序已认证**：个人开发者可能有功能限制
2. **网络环境**：确保网络连接稳定
3. **开发环境**：在体验版中测试功能
4. **日志检查**：遇到问题时查看控制台日志

## 📞 如果仍有问题

1. 运行诊断功能获取详细错误信息
2. 检查云开发控制台的错误日志
3. 确认账号权限和认证状态 