# 云开发配置指南

## 🚀 云开发环境设置

### 1. 开通云开发
1. 在微信开发者工具中打开项目
2. 点击 **云开发** 按钮
3. 开通云开发服务，创建环境
4. 记录环境ID（env-xxxxx）

### 2. 配置环境ID
在 `app.js` 中的 `initCloud()` 方法中，将环境ID填入：

```javascript
wx.cloud.init({
  env: 'your-env-id', // 替换为你的环境ID
  traceUser: true,
})
```

### 3. 部署云函数
1. 在微信开发者工具中，右击 `cloudfunctions/login` 文件夹
2. 选择 **上传并部署：云端安装依赖**
3. 等待部署完成

### 4. 创建数据库集合
1. 在云开发控制台中，进入 **数据库**
2. 创建集合：`Babalance-user`
3. 设置权限：**仅创建者可读写**

## 📋 数据库结构

### Babalance-user 集合
```json
{
  "_id": "自动生成的文档ID",
  "_openid": "用户的openid",
  "name": "宝宝姓名",
  "gender": "性别 (male/female)",
  "birthday": "生日 (YYYY-MM-DD)",
  "avatar": "头像URL",
  "createTime": "创建时间",
  "updateTime": "更新时间"
}
```

## 🔄 数据同步机制

### 双重存储策略
- **本地存储**：使用 `wx.setStorageSync()` 进行本地缓存
- **云数据库**：使用云数据库进行云端备份和同步

### 数据流程
1. **加载数据**：先从本地加载，再从云端同步
2. **保存数据**：同时保存到本地和云端
3. **冲突处理**：云端数据优先级更高

## 🛠️ API说明

### app.js 全局方法

#### `initCloud()`
- 初始化云开发环境
- 获取用户openid

#### `saveBabyInfo(babyInfo)`
- 保存宝宝信息到本地和云端
- 自动处理创建/更新逻辑

#### `loadBabyInfoFromCloud()`
- 从云数据库加载宝宝信息
- 同步到本地存储

#### `getBabyInfo()`
- 获取当前宝宝信息

### profile.js 页面方法

#### `loadBabyInfo()`
- 加载宝宝信息（本地+云端）

#### `updateBabyInfo(field, value)`
- 更新指定字段的宝宝信息
- 自动保存到云端

## 🚨 注意事项

1. **网络依赖**：云数据库需要网络连接，离线时使用本地缓存
2. **权限控制**：数据库设置为仅创建者可读写，确保数据安全
3. **错误处理**：云端操作失败时会回退到本地存储
4. **性能优化**：本地优先加载，云端后台同步

## 🔧 故障排除

### 常见问题

1. **云函数调用失败**
   - 检查云函数是否正确部署
   - 确认网络连接正常

2. **数据库权限错误**
   - 确认集合权限设置为"仅创建者可读写"
   - 检查用户是否已登录

3. **环境ID错误**
   - 确认 `app.js` 中的环境ID正确
   - 检查云开发环境是否开通

## 📱 使用方法

1. 用户首次打开小程序，自动获取openid
2. 编辑宝宝信息时，数据自动保存到云端
3. 换设备登录时，云端数据自动同步到本地
4. 离线使用时，依然可以查看和编辑本地数据

## 🔄 数据迁移

如果你已有本地数据，首次开启云功能时：
1. 本地数据会自动上传到云端
2. 之后所有操作都会同步到云端
3. 多设备间数据自动保持一致 